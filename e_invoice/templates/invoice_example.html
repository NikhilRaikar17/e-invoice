{% extends 'base.html' %}

{% block breadcrumb %}
  <li class="breadcrumb-item active">{% block title %}Create New Invoice{% endblock %}</li>
{% endblock %}

{% block content %}
  <h1>Generate E-invoice</h1>
  <hr/>

    <div class="card">
        <div class="card-body">
            <div class="container mb-5 mt-3">
                <div class="row  align-items-baseline pb-3">
                    <div class="col-xl-7">
                        <p style="color: #2d4e95;font-size: 20px;">Invoice for customer</p>
                    </div>
                    <div class="col-xl-5 float-end">
                        
                        <a  class="btn btn-light text-capitalize border-0" 
                            data-toggle="modal" 
                            data-title="Add" 
                            data-target="#select-customer" 
                            data-mdb-ripple-color="dark"
                            >
                            <i class="fa-solid fa-user" style="color: #2d4e95;"></i> 
                            Select Customer
                        </a>
                        
                        <a  class="btn btn-light text-capitalize border-0"
                            id="clear_customer_data"
                            name="clear_customer_data" 
                            onclick="clear_customer_details()"
                            data-mdb-ripple-color="dark"
                            >
                            <i class="fa-solid fa-arrow-rotate-right"></i> 
                            Restart
                        </a>

                        <a  class="btn btn-light text-capitalize border-0"
                            data-mdb-ripple-color="dark">
                            <i  class="fas fa-print" 
                                style="color: #2d4e95;">
                            </i> 
                            Print
                        </a>
                        
                        <a  class="btn btn-light text-capitalize"
                            data-mdb-ripple-color="dark">
                            <i  class="far fa-file-pdf" 
                                style="color: #2d4e95;">
                            </i> 
                            Export
                        </a>
                    </div>
                
                </div>

                <hr>
        
                <div class="container">
                    <div class="col-md-12">
                        <div class="text-center">
                            <i class="fas fa-mail-bulk ms-0" style="font-size:50px; color:#2d4e95 ;"></i>
                            <p class="pt-0">Example GmbH</p>
                        </div>
            
                    </div>
            
                    <div class="row">
                        <div class="col-xl-8">
                            <ul class="list-unstyled" id="sender_information">
                                <li class="text-muted" id="customers-name">To: <span style="color:#2d4e95 ;"></span></li>
                                <li class="text-muted" id="address">Street, City</li>
                                <li class="text-muted" id="email">State, Country</li>
                                <li class="text-muted" id="phone_number"><i class="fas fa-phone"> &nbsp;</i> 123-456-789</li>
                            </ul>
                        </div>
                        <div class="col-xl-4">
                            <ul class="list-unstyled">
                                <li class="text-muted"><i class="fas fa-circle" style="color:#2d4e95 ;"></i> <span
                                    class="fw-bold" style="opacity:0.6;">ID:</span>#123-456</li>
                                <li class="text-muted pt-2"><i class="fas fa-circle" style="color:#2d4e95 ;"></i> 
                                    <span class="fw-bold">Creation Date: {{date_time}}</span>
                                </li>
                                <li class="text-muted pt-2">
                                    <i class="fas fa-circle" style="color:#2d4e95 ;"></i> 
                                    <span class="fw-bold">Due Date: </span>
                                    <input class="form-control-sm" type="date" id="start-date" name="start-date" required style="width:150px;height:20px;"></input>
                                </li>
                                <li class="text-muted pt-2"><i class="fas fa-circle" style="color:#2d4e95 ;"></i> 
                                    <span class="me-1 fw-bold">Status:</span>
                                    <span class="badge bg-warning text-black fw-bold">
                                    Unpaid</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                
                    <div class="row my-2 mx-1 justify-content-center">
                        
                        <table class="table table-striped table-borderless" id="products_table">
                            <thead id="products_table_header" style="background-color:#2d4e95 ;" class="text-white">
                                <tr>
                                <th scope="col">#</th>
                                <th scope="col">Description</th>
                                <th scope="col">Qty</th>
                                <th scope="col">Unit Price</th>
                                <th scope="col">Amount</th>
                                </tr>
                            </thead>
                            
                            <tbody id="products-table-body">
                                <tr>
                                    <th scope="row">1</th>
                                    <td>Pro Package</td>
                                    <td>4</td>
                                    <td>$200</td>
                                    <td>$800</td>
                                </tr>
                                <tr>
                                    <th scope="row">2</th>
                                    <td>Web hosting</td>
                                    <td>1</td>
                                    <td>$10</td>
                                    <td>$10</td>
                                </tr>
                                <tr>
                                    <th scope="row">3</th>
                                    <td>Consulting</td>
                                    <td>1 year</td>
                                    <td>$300</td>
                                    <td>$300</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <button 
                                class="btn btn-light border-0 text-capitalize float-start" 
                                id="add_products"
                                data-toggle="modal"
                                data-title="Add"
                                data-target="#add_products_invoice"
                                style="width: 10%;background-color:#6d952d;"
                            > 
                            Add Products
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-xl-8">
                        </div>
                        <div class="col-xl-3 mx-5">
                            <ul class="list-unstyled">
                                <li class="text-muted ms-3" id="sub_total"><span class="text-black me-4">SubTotal</span>$1110</li>
                                <li class="text-muted ms-3 mt-2" id="tax"><span class="text-black me-4">Tax(15%)</span>$111</li>
                            </ul>
                            <p class="text-black float-start">
                                <span class="text-black me-3"> Total Amount</span>
                                <span style="font-size: 25px;">$1221</span>
                            </p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-xl-9">
                        </div>
                        <div class="col-xl-2">
                            <button type="button" 
                                    class="btn btn-primary text-capitalize"
                                    style="background-color:#2d4e95 ;"
                                    >
                                    Generate PDF
                            </button>
                        </div>
                    </div>
        
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="select-customer" tabindex="-1">
        <div class="modal-dialog">
          
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="Heading">Generate Invoice</h4>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                  <span>×</span>
                </button>
              </div>
              <div class="modal-body">
    
                <div class="form-group">
                  <label for="customer-name"><b>Customer Name</b></label>
                  <select name="select_customers" id="select_customers" class="form-control">
                    <option value="-1">---</option>
                    {% for customer in customers %}
                        <option value="{{customer.id}}"> {{ customer.name }} </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
    
              <div class="modal-footer ">
                <button class="btn btn-success btn-lg" data-dismiss="modal" style="width: 100%;" onclick="fill_invoice_form();">
                  Select
                </button>
              </div>
              
            </div>       
        </div>
    </div>

    <div class="modal fade" id="add_products_invoice" tabindex="-1">
        <div class="modal-dialog">
          
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="Heading">All Products</h4>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                  <span>×</span>
                </button>
              </div>
              <div class="modal-body">
    
                <div class="form-group">
                  <label for="customer-name"><b>Products</b></label>
                  <select class="selectpicker" multiple id="select_products" >
                    {% for product in products %}
                        <option value="{{product.id}}" product_price="{{product.price}}"> {{ product.name }} </option>
                    {% endfor %}
                  </select>
                </div>
              </div>
    
              <div class="modal-footer ">
                <button class="btn btn-success btn-lg" data-dismiss="modal" style="width: 100%;" onclick="update_table_with_products();">
                  Select
                </button>
              </div>
              
            </div>       
        </div>
    </div>

{% endblock %}
{% block scripts %}
    <script>
        var customer_data = document.getElementById("clear_customer_data");
        var cust_name = document.getElementById("customers-name");
        var address = document.getElementById("address");
        var email = document.getElementById("email");
        var phone_number = document.getElementById("phone_number");
        var table = document.getElementById("products_table");
        var table_header = document.getElementById("products_table_header");
        var table_body = document.getElementById("products-table-body");
        var sender_information = document.getElementById("sender_information");

        function fill_invoice_form(){
        // Fills the invoice form with customers data
            var selected_value = select_customers.options[select_customers.selectedIndex].value;
                if (selected_value != '-1'){
                    $.ajax({
                        type: "GET",
                        url: "{{url_for('get_customer_details')}}",
                        data: {"customer_id":   selected_value },
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function(result){
                            if (!result["ERROR"]){
                                cust_name.childNodes[1].textContent = result["name"]
                                address.textContent = result["address"]
                                email.textContent = result["email"]
                                phone_number.childNodes[1].textContent = result["phone_number"]
                                add_products.disabled = !add_products.disabled;
                            } else{
                                add_products.disabled = true;
                            }
                        }
                    });
                }
        }

    </script>  
{% endblock %}